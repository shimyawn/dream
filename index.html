<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTMILL Guestbook</title>
    
    <!-- Pretendard Web Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { 
            margin: 0; overflow: hidden; background-color: #ffffff; 
            font-family: 'Pretendard', sans-serif; 
            user-select: none; -webkit-user-select: none; 
        }
        canvas { display: block; }
        
        /* UI ë ˆì´ì•„ì›ƒ */
        #ui { position: absolute; top: 30px; left: 30px; pointer-events: none; color: #333; z-index: 10; transition: all 0.3s; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        
        /* ì‹œë®¬ë ˆì´ì…˜ ì»¨íŠ¸ë¡¤ */
        #sim-controls { display: flex; gap: 6px; pointer-events: auto; }
        #sim-controls button {
            background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1; border-radius: 8px;
            padding: 8px 14px; cursor: pointer; font-size: 0.9rem; color: #334155;
            font-weight: 700; font-family: 'Pretendard'; transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center;
            min-width: 40px;
        }
        #sim-controls button:hover { background: #fff; color: #0ea5e9; border-color: #0ea5e9; transform: translateY(-1px); }
        #sim-controls button:active { transform: translateY(0); }
        
        /* ë„ì›€ë§ ë²„íŠ¼ í™œì„± ìƒíƒœ */
        #btn-help.active { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }

        /* ë„ì›€ë§ íŒì—… ë°•ìŠ¤ */
        #help-popup {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #cbd5e1; border-radius: 16px;
            padding: 16px; width: 260px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            pointer-events: auto;
            animation: popIn 0.2s ease;
            font-size: 0.8rem; color: #475569; line-height: 1.6;
        }
        .help-section { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #e2e8f0; }
        .help-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .help-title { font-weight: 800; color: #1e293b; margin-bottom: 6px; display: block; font-size: 0.85rem; }
        .help-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .dot.green { background: #00e676; }
        .dot.blue { background: #2979ff; }
        .dot.yellow { background: #ef4444; } 
        .dot.gray { background: #64748b; }
        
        .warning-txt { color: #ea580c; font-weight: 600; background: #fff7ed; padding: 8px; border-radius: 8px; margin-top: 5px; font-size: 0.75rem; }

        /* ìš°í¸í•¨ ì•„ì´ì½˜ */
        #mailbox-icon {
            position: absolute; right: 30px; bottom: 210px; width: 40px; height: 50px;
            background: #ef4444; border: 4px solid #7f1d1d; border-radius: 8px 8px 0 0;
            cursor: pointer; z-index: 25; box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        #mailbox-icon:active { transform: scale(0.95); }
        #mailbox-icon::after { content: ''; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 20px; height: 6px; background: #7f1d1d; border-radius: 2px; }
        #mailbox-icon::before { content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 8px; height: 20px; background: #333; z-index: -1; }
        #mailbox-text {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #mailbox-icon:hover #mailbox-text { opacity: 1; }

        .green-txt { color: #00e676; font-weight: 700; }
        .blue-txt { color: #2979ff; font-weight: 700; }
        .yellow-txt { color: #ef4444; font-weight: 700; } 
        .gray-txt { color: #555; font-weight: 700; }

        /* ì•ˆë‚´ ë©˜íŠ¸ (ìš°ì¸¡ ìƒë‹¨) */
        #guide-text {
            position: absolute; top: 30px; right: 30px; text-align: right; color: #444; pointer-events: auto; z-index: 10;
            background: rgba(255,255,255,0.9); padding: 18px 22px; border-radius: 16px; backdrop-filter: blur(8px); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); letter-spacing: -0.01em; border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer; user-select: none;
        }
        #guide-text h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: #1e293b; font-weight: 800; }
        #guide-text p { margin: 0; font-size: 0.9rem; line-height: 1.6; color: #475569; font-weight: 500; word-break: keep-all; }

        /* í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #audio-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: #2c3e50; color: white; border: 3px solid white; border-radius: 50%; cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s; }
        #audio-btn:active { transform: scale(0.9); }

        /* ì•Œë¦¼ì°½ */
        #custom-alert { display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 200; text-align: center; border: 1px solid #eee; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 320px; }
        #custom-alert h3 { margin: 0 0 10px 0; color: #2c3e50; font-weight: 700; font-size: 1.3rem; }
        #pc-toast { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(30, 41, 59, 0.9); color: white; padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 300; text-align: center; font-size: 0.9rem; pointer-events: none; animation: fadeInOut 2.5s ease forwards; }

        /* í†µí•© ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; height: 600px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 100; flex-direction: column; overflow: hidden; border: 1px solid #f1f1f1; animation: fadeIn 0.3s ease; max-width: 90%; max-height: 90%; }
        
        .modal-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f1f1f1; display: flex; justify-content: space-between; align-items: center; z-index: 10; position: relative;}
        
        .main-tabs { display: flex; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 12px; }
        .tab-btn {
            border: none; background: transparent; padding: 8px 16px; border-radius: 8px;
            font-size: 0.9rem; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s;
            font-family: 'Pretendard';
        }
        .tab-btn.active { background: white; color: #0f172a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn:hover:not(.active) { color: #334155; }

        .view-toggle { display: flex; background: #f1f5f9; border-radius: 20px; padding: 4px; gap: 4px; font-size: 0.85rem; font-weight: 600; margin-left: auto; margin-right: 15px; }
        .view-toggle label { cursor: pointer; padding: 6px 12px; border-radius: 16px; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .view-toggle label.active { background: white; color: #0ea5e9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .close-modal-btn { cursor: pointer; font-size: 1.8rem; color: #94a3b8; line-height: 1; margin-left: 10px; }
        
        .tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%; }

        .msg-list-container { flex: 1; overflow-y: auto; padding: 0; background: #f8fafc; }
        .list-item { padding: 20px 25px; border-bottom: 1px solid #f1f5f9; background: white; }
        .list-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; }
        .list-receiver { font-weight: 700; color: #0ea5e9; margin-right: 6px; font-size: 0.95rem; }
        .list-text { color: #334155; font-size: 1rem; word-break: break-all; line-height: 1.5; }
        .empty-msg { text-align: center; padding: 40px; color: #94a3b8; font-size: 0.95rem; }
        
        #my-msg-auth { padding: 20px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; z-index: 10; position: relative; }
        #my-name-input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-family: 'Pretendard'; }
        #my-msg-btn { background: #0ea5e9; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'Pretendard'; }
        #mailbox-content-area { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        #mailbox-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; overflow: hidden; display: none; }
        #mailbox-bg-canvas { width: 100%; height: 100%; cursor: pointer; }
        #mailbox-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; text-align: center; width: 100%; pointer-events: none; line-height: 1.6; }
        #my-msg-list-container { flex: 1; overflow-y: auto; background: #f8fafc; display: none; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 90; backdrop-filter: blur(4px); }

        #input-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 620px; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); display: flex; align-items: center; gap: 8px; z-index: 30; border: 1px solid #e2e8f0; backdrop-filter: blur(10px); }
        
        .to-all-wrapper { display: flex; align-items: center; white-space: nowrap; font-size: 14px; font-weight: 600; color: #475569; margin-right: 2px; cursor: pointer; user-select: none; }
        .to-all-wrapper input { margin-right: 4px; accent-color: #0ea5e9; width: 16px; height: 16px; cursor: pointer; }

        #receiver-input { width: 80px; padding: 12px; border: none; border-radius: 25px; background: #e0f2fe; text-align: center; outline: none; font-size: 15px; font-family: 'Pretendard', sans-serif; font-weight: 600; color: #0369a1; transition: all 0.2s; } 
        #receiver-input::placeholder { color: #7dd3fc; font-weight: 500; }
        #receiver-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

        #msg-input { flex: 1; padding: 12px 16px; border: none; border-radius: 25px; background: #f1f5f9; outline: none; font-size: 16px; font-family: 'Pretendard', sans-serif; color: #334155; }
        #send-btn { background: #0ea5e9; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: background 0.2s, transform 0.1s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); flex-shrink: 0; }
        #send-btn:hover { background: #0284c7; transform: scale(1.05); }
        #send-btn:active { transform: scale(0.95); }
        #send-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }

        #style-group { position: relative; display: flex; align-items: center; }
        #style-toggle-btn {
            width: 42px; height: 42px; border-radius: 50%; border: 1px solid #cbd5e1; background: #fff;
            color: #64748b; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #style-toggle-btn:hover { background: #f1f5f9; color: #334155; }
        #style-toggle-btn.active { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }

        #style-options {
            position: absolute; bottom: 55px; left: 0; 
            background: white; padding: 8px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;
            display: none; flex-direction: column; gap: 8px;
            animation: popIn 0.2s ease;
        }
        #style-options.show { display: flex; }
        
        .style-opt-btn {
            width: 40px; height: 40px; border-radius: 12px; border: 1px solid #e2e8f0;
            background: #f8fafc; cursor: pointer; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .style-opt-btn:hover { background: #f1f5f9; }
        
        .style-indicator {
            position: absolute; bottom: -2px; right: -2px;
            width: 16px; height: 16px; border-radius: 50%;
            background: #333; border: 2px solid white;
            font-size: 10px; color: white; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: 'Pretendard', sans-serif;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -40%); } 10% { opacity: 1; transform: translate(-50%, -50%); } 90% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -60%); } }

        @media (max-width: 768px) {
            #guide-text { display: block; top: 10px; left: 50%; right: auto; transform: translateX(-50%); width: 90%; text-align: center; }
            #audio-btn { bottom: auto; top: 20px; right: 20px; width: 40px; height: 40px; font-size: 1.2rem; }
            #ui { top: 95px; width: 92%; }
            #sim-controls { width: 100%; justify-content: center; }
            #mailbox-icon { right: 20px; bottom: 210px; }
            #input-bar { bottom: 20px; width: 95%; padding: 8px; gap: 6px; }
            .to-all-wrapper { font-size: 13px; }
            #receiver-input { width: 50px; font-size: 13px; }
            #msg-input { font-size: 14px; }
            #send-btn { width: 36px; height: 36px; font-size: 1rem; }
            #style-toggle-btn { width: 36px; height: 36px; font-size: 1.1rem; }
            .modal-window { width: 380px; height: 550px; }
        }
    </style>
</head>
<body>

    <div id="ui">
        <!-- ì†ë„ ë° ì¼ì‹œì •ì§€ ì»¨íŠ¸ë¡¤ + ì˜¤ë””ì˜¤ + ë„ì›€ë§ + ë¦¬ì…‹ -->
        <div id="sim-controls">
            <button onclick="togglePause()" id="btn-pause" title="ì¼ì‹œì •ì§€/ì¬ìƒ">â¸</button>
            <button onclick="toggleSpeed()" id="btn-speed" title="ì†ë„ ì¡°ì ˆ">1x</button>
            <button onclick="resetSimulation()" id="btn-reset" title="ì‘ì—… ì´ˆê¸°í™”">ğŸ”„</button>
            <button id="btn-audio" title="ë°°ê²½ìŒì•… On/Off">ğŸ”‡</button>
            <button onclick="toggleHelp()" id="btn-help" title="ë„ì›€ë§ ë° ì‚¬ìš©ë²•">?</button>
        </div>

        <!-- ë„ì›€ë§ íŒì—… -->
        <div id="help-popup">
            <div class="help-section">
                <span class="help-title">ğŸ’¡ ìƒ‰ìƒë³„ ì˜ë¯¸</span>
                <div class="help-row"><div class="dot green"></div> ë°©ê¸ˆ ë„ì°©í•œ ë©”ì‹œì§€ ì•Œë¦¼</div>
                <div class="help-row"><div class="dot blue"></div> íŒŒë€ ì˜·ì„ ì…ì€ ë™ë£Œë“¤</div>
                <div class="help-row"><div class="dot yellow"></div> ë¹¨ê°„ ìš°í¸í•¨: ë‚´ ë©”ì‹œì§€í•¨</div>
                <div class="help-row"><div class="dot gray"></div> ğŸ”„ ë²„íŠ¼: ì‘ì—… ë¦¬ì…‹</div>
            </div>
            <div class="help-section">
                <span class="help-title">ğŸ“¨ ë©”ì‹œì§€ ë³´ë‚´ëŠ” ë²•</span>
                <p>
                    í•˜ë‹¨ ë°”ì—ì„œ ë°›ëŠ” ì‚¬ëŒ ì´ë¦„ì„(3ê¸€ì) ì…ë ¥í•˜ê±°ë‚˜ 'ëª¨ë‘'ë¥¼ ì²´í¬í•˜ê³ ,
                    ğŸ‘• ë²„íŠ¼ìœ¼ë¡œ ìºë¦­í„°ë¥¼ ê¾¸ë¯¼ ë’¤ ë©”ì‹œì§€ë¥¼ ì ì–´ ì „ì†¡í•˜ì„¸ìš”!
                </p>
                <div class="warning-txt">
                    âš ï¸ í•œ ë²ˆì— ë„ˆë¬´ ë§ì€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆì–´ìš©! ì¡°ê¸ˆë§Œ ì²œì²œíˆ ë³´ë‚´ì£¼ì„¸ìš© ğŸ¥º
                </div>
            </div>
        </div>
    </div>

    <div id="mailbox-icon" title="ë‚´ ìš°í¸í•¨ í™•ì¸í•˜ê¸°" onclick="openMyMsgModal()">
        <div id="mailbox-text">ë‚´ ìš°í¸í•¨</div>
    </div>

    <!-- ìš°ì¸¡ ìƒë‹¨ ì•ˆë‚´ í…ìŠ¤íŠ¸ (ì´ìŠ¤í„°ì—ê·¸ íŠ¸ë¦¬ê±°) -->
    <div id="guide-text" onclick="handleGuideClick()">
        <h2>2026 ë‹·ë°€ ì‹ ë…„ë§ì´ ë¡¤ë§í˜ì´í¼ ğŸ“œ</h2>
        <p>
            ì—¬ê¸°ëŠ” DOTì„ êµ´ë ¤ ë©‹ì§„ ê²ƒë“¤ì„ ë§Œë“œëŠ” ë°©ì•—ê°„, DOMILLì…ë‹ˆë‹¤.<br>
            í™”ë©´ì— ë³´ì´ëŠ” ë™ë£Œë“¤ì„ í´ë¦­í•´ì„œ íœ´ì‹ì„ ì„ ë¬¼í•˜ì„¸ìš”.<br>
            ê·¸ë¦¬ê³  ë™ë£Œë“¤ì—ê²Œ ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „í•˜ì„¸ìš”.
        </p>
    </div>

    <div id="custom-alert">
        <span id="alert-check">âœ…</span>
        <h3>ì „ì†¡ ì™„ë£Œ!</h3>
        <p>ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë¬´ì‚¬íˆ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¨</p>
    </div>

    <div id="pc-toast">
        PCì—ì„œ ì ‘ì†í•˜ì‹œë©´ ìµœì í™”ëœ ê²½í—˜ì„ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ’»
    </div>

    <div id="modal-overlay"></div>

    <!-- í†µí•© ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div id="my-msg-modal" class="modal-window">
        <div class="modal-header">
            <!-- ë©”ì¸ íƒ­ -->
            <div class="main-tabs">
                <button class="tab-btn active" id="tab-my" onclick="setMailboxTab('MY')">ë‚´ ìš°í¸í•¨ ğŸ“¬</button>
                <button class="tab-btn" id="tab-all" onclick="setMailboxTab('ALL')">ì „ì²´ ë©”ì‹œì§€ ğŸ“œ</button>
            </div>
            
            <!-- ë‚´ ë©”ì‹œì§€ íƒ­ì¼ ë•Œë§Œ ë³´ì´ëŠ” ë·° í† ê¸€ -->
            <div class="view-toggle" id="my-view-toggle">
                <label id="toggle-list" onclick="setViewMode('list')">ğŸ“„ ëª©ë¡</label>
                <label id="toggle-scene" onclick="setViewMode('scene')" class="active">âœ¨ ì¥ë©´</label>
            </div>
            
            <span class="close-modal-btn" data-target="my-msg-modal">Ã—</span>
        </div>

        <!-- TAB 1: ë‚´ ìš°í¸í•¨ ë‚´ìš© -->
        <div id="tab-content-my" class="tab-content">
            <div id="my-msg-auth">
                <input type="text" id="my-name-input" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter') checkMyMessages()">
                <button id="my-msg-btn" onclick="checkMyMessages()">í™•ì¸</button>
            </div>
            <div id="mailbox-content-area">
                <div id="mailbox-placeholder">ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>(ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤)</div>
                <div id="my-msg-list-container"></div>
                <div id="mailbox-canvas-container">
                    <canvas id="mailbox-bg-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB 2: ì „ì²´ ë©”ì‹œì§€ ë‚´ìš© -->
        <div id="tab-content-all" class="tab-content" style="display:none;">
            <div id="all-msg-list" class="msg-list-container"><div class="empty-msg">ë¡œë”© ì¤‘... â³</div></div>
        </div>
    </div>

    <div id="input-bar">
        <label class="to-all-wrapper" title="ì²´í¬í•˜ë©´ ëª¨ë‘ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤">
            <input type="checkbox" id="to-all-check">
            <span>ëª¨ë‘</span>
        </label>
        
        <input type="text" id="receiver-input" placeholder="ë°›ëŠ”ë¶„" maxlength="5">
        
        <!-- ìŠ¤íƒ€ì¼ ì„¤ì • ë²„íŠ¼ ê·¸ë£¹ -->
        <div id="style-group">
            <button id="style-toggle-btn" title="ìºë¦­í„° ê¾¸ë¯¸ê¸°">ğŸ‘•</button>
            <div id="style-options">
                <div class="style-opt-btn" onclick="cycleStyle('hair')" title="í—¤ì–´ìŠ¤íƒ€ì¼">
                    ğŸ’‡â€â™€ï¸ <div class="style-indicator" id="ind-hair">ğŸ§‘</div>
                </div>
                <div class="style-opt-btn" onclick="cycleStyle('shirt')" title="ì˜· ìƒ‰ìƒ">
                    ğŸ¨ <div class="style-indicator" id="ind-shirt" style="background: #3b82f6;"></div>
                </div>
                <div class="style-opt-btn" onclick="cycleStyle('acc')" title="ì¥ì‹">
                    ğŸ€ <div class="style-indicator" id="ind-acc">âŒ</div>
                </div>
            </div>
        </div>

        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ (ìµëª…)" autocomplete="off" maxlength="40">
        <button id="send-btn">â¤</button>
    </div>

    <canvas id="canvas"></canvas>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVUstSVxUqWBzLgxCoNUqRE02DVGa8dbjWFl6opbPqiqokuCjn9dEEf9qn6jrrW09QFA/exec";

    const audioFiles = {};
    const soundNames = ['bgm', 'sent', 'rest', 'pop', 'reset'];
    let isBgmOn = false; 
    
    soundNames.forEach(name => {
        const audio = new Audio(`sounds/${name}.mp3`);
        if(name === 'bgm') { audio.loop = true; audio.volume = 0.4; } 
        else { audio.volume = name === 'reset' ? 1.0 : 0.8; if(name === 'pop') audio.volume = 0.5; }
        audioFiles[name] = audio;
    });

    const audioBtn = document.getElementById('btn-audio');
    audioBtn.addEventListener('click', () => {
        if (isBgmOn) {
            audioFiles['bgm'].pause(); audioBtn.innerText = 'ğŸ”‡'; isBgmOn = false;
        } else {
            audioFiles['bgm'].play().then(() => { audioBtn.innerText = 'ğŸ”Š'; isBgmOn = true; })
            .catch(e => { alert("ì†Œë¦¬ íŒŒì¼ì„ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); });
        }
    });
    
    function playSound(name) {
        if (isBgmOn && audioFiles[name]) { audioFiles[name].currentTime = 0; audioFiles[name].play().catch(e => {}); }
    }

    const receiverInput = document.getElementById('receiver-input'); 
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const toAllCheck = document.getElementById('to-all-check'); 
    const myMsgModal = document.getElementById('my-msg-modal');
    const overlay = document.getElementById('modal-overlay');
    const closeBtns = document.querySelectorAll('.close-modal-btn');
    const myNameInput = document.getElementById('my-name-input');
    const customAlert = document.getElementById('custom-alert');

    const CUSTOM_SHIRT_COLORS = [
        '#3b82f6', '#1e293b', '#64748b', 
        '#ef4444', '#f97316', '#eab308', 
        '#22c55e', '#0ea5e9', '#6366f1', '#a855f7'
    ]; 
    const HAIR_ICONS = ['ğŸ§‘', 'ğŸ¦±', 'ğŸ‘±', 'ğŸ‘©']; 
    const ACC_ICONS = ['âŒ', 'ğŸ„', 'ğŸŒ¸']; 

    let currentStyle = { hair: 0, shirt: 0, acc: 0 };

    const styleToggleBtn = document.getElementById('style-toggle-btn');
    const styleOptions = document.getElementById('style-options');
    const indHair = document.getElementById('ind-hair');
    const indShirt = document.getElementById('ind-shirt');
    const indAcc = document.getElementById('ind-acc');

    styleToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        styleOptions.classList.toggle('show');
        styleToggleBtn.classList.toggle('active');
    });

    window.addEventListener('click', (e) => {
        if (!e.target.closest('#style-group')) {
            styleOptions.classList.remove('show');
            styleToggleBtn.classList.remove('active');
        }
    });

    function cycleStyle(type) {
        if (type === 'hair') {
            currentStyle.hair = (currentStyle.hair + 1) % HAIR_ICONS.length;
            indHair.innerText = HAIR_ICONS[currentStyle.hair];
        } else if (type === 'shirt') {
            currentStyle.shirt = (currentStyle.shirt + 1) % CUSTOM_SHIRT_COLORS.length;
            indShirt.style.backgroundColor = CUSTOM_SHIRT_COLORS[currentStyle.shirt];
        } else if (type === 'acc') {
            currentStyle.acc = (currentStyle.acc + 1) % ACC_ICONS.length;
            indAcc.innerText = ACC_ICONS[currentStyle.acc];
        }
    }

    let currentMailboxTab = 'MY';

    window.setMailboxTab = (tab) => {
        currentMailboxTab = tab;
        const tabMy = document.getElementById('tab-my');
        const tabAll = document.getElementById('tab-all');
        const contentMy = document.getElementById('tab-content-my');
        const contentAll = document.getElementById('tab-content-all');
        const myViewToggle = document.getElementById('my-view-toggle');

        if (tab === 'MY') {
            tabMy.classList.add('active'); tabAll.classList.remove('active');
            contentMy.style.display = 'flex'; contentAll.style.display = 'none';
            myViewToggle.style.visibility = 'visible'; setViewMode(currentViewMode); 
        } else {
            tabMy.classList.remove('active'); tabAll.classList.add('active');
            contentMy.style.display = 'none'; contentAll.style.display = 'flex';
            myViewToggle.style.visibility = 'hidden';
            if (mbAnimationId) cancelAnimationFrame(mbAnimationId); 
            renderAllMessages();
        }
    }

    let currentViewMode = 'scene';
    const mbListContainer = document.getElementById('my-msg-list-container');
    const mbCanvasContainer = document.getElementById('mailbox-canvas-container');
    const mbToggleList = document.getElementById('toggle-list');
    const mbToggleScene = document.getElementById('toggle-scene');

    function setViewMode(mode) {
        currentViewMode = mode;
        if (mode === 'list') {
            mbListContainer.style.display = 'block'; mbCanvasContainer.style.display = 'none';
            mbToggleList.classList.add('active'); mbToggleScene.classList.remove('active');
            if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
        } else {
            mbListContainer.style.display = 'none'; mbCanvasContainer.style.display = 'block';
            mbToggleList.classList.remove('active'); mbToggleScene.classList.add('active');
            resizeMailboxCanvas(); animateMailbox(); 
        }
    }

    function resizeMailboxCanvas() {
        const rect = document.getElementById('mailbox-content-area').getBoundingClientRect();
        mbCanvas.width = rect.width; mbCanvas.height = rect.height;
    }

    const mbCanvas = document.getElementById('mailbox-bg-canvas');
    const mbCtx = mbCanvas.getContext('2d');
    const mbPlaceholder = document.getElementById('mailbox-placeholder');
    let mbDancers = [];
    let mbSnowflakes = [];
    let mbAnimationId = null;
    let mbMouse = { x: -1000, y: -1000 };

    mbCanvas.addEventListener('mousemove', (e) => {
        const rect = mbCanvas.getBoundingClientRect();
        const scaleX = mbCanvas.width / rect.width; const scaleY = mbCanvas.height / rect.height;
        mbMouse.x = (e.clientX - rect.left) * scaleX; mbMouse.y = (e.clientY - rect.top) * scaleY;
    });
    mbCanvas.addEventListener('mouseleave', () => { mbMouse.x = -1000; mbMouse.y = -1000; });

    toAllCheck.addEventListener('change', (e) => {
        if (e.target.checked) {
            receiverInput.disabled = true; receiverInput.value = ''; receiverInput.placeholder = 'ì „ì²´';
        } else {
            receiverInput.disabled = false; receiverInput.placeholder = 'ë°›ëŠ”ë¶„';
        }
    });

    function showCustomAlert() {
        customAlert.style.display = 'block'; setTimeout(() => { customAlert.style.display = 'none'; }, 2500);
    }

    async function sendMessage() {
        let receiver = '';
        const rawName = receiverInput.value.trim();

        if (toAllCheck.checked) {
            receiver = 'ALL';
        } else {
            const namePattern = /^[ê°€-í£]{3}$/;
            if (!namePattern.test(rawName)) return alert("ë°›ëŠ” ë¶„ì˜ ì •í™•í•œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(í•œê¸€ 3ê¸€ì)");
            receiver = rawName;
        }

        const text = msgInput.value.trim();
        if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        sendBtn.disabled = true; const originalPlaceholder = msgInput.placeholder;
        msgInput.value = ''; msgInput.placeholder = 'ì „ì†¡ ì¤‘... ğŸš€';
        
        const styleData = JSON.stringify(currentStyle);
        const finalPayload = { name: receiver, text: text, style: styleData };

        const performFetch = async (retries = 3, delay = 1500) => {
            try {
                await fetch(GOOGLE_SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    cache: 'no-cache', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify(finalPayload) 
                });
            } catch (err) {
                console.error("Send Error:", err);
                if (retries > 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return performFetch(retries - 1, delay * 2);
                } else {
                    throw err;
                }
            }
        };

        try {
            await performFetch();
            
            if (window.distributeSingleMessage) {
                window.distributeSingleMessage({ 
                    name: receiver, 
                    text: text, 
                    style: { ...currentStyle } 
                });
            }
            playSound('sent'); showCustomAlert();
            if (!toAllCheck.checked) receiverInput.value = ''; 
        } catch (error) { 
            console.error("Final failure:", error);
            alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ í˜¼ì¡ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)"); 
        } finally { 
            sendBtn.disabled = false; msgInput.placeholder = originalPlaceholder; msgInput.focus(); 
        }
    }

    async function renderAllMessages() {
        const container = document.getElementById('all-msg-list');
        container.innerHTML = '<div class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...<br>(ì•½ 1~2ì´ˆ ì†Œìš”)</div>';
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); container.innerHTML = ''; 
            if (!data || data.length === 0) { container.innerHTML = '<div class="empty-msg">ë©”ì‹œì§€ ì—†ìŒ</div>'; return; }
            data.forEach(row => {
                const dateRaw = new Date(row[0]); const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
                const div = document.createElement('div'); div.className = 'list-item';
                let displayMsg = row[2] || "";
                let displayReceiver = row[1];
                let receiverClass = 'list-receiver';
                if (displayReceiver === 'ALL') {
                    displayReceiver = 'ëª¨ë‘ì—ê²Œ ğŸ“¢'; receiverClass = 'list-receiver green-txt'; 
                } else {
                    displayReceiver = `To. ${displayReceiver}`;
                }
                div.innerHTML = `<div class="list-date">${dateStr}</div><div><span class="${receiverClass}">${displayReceiver}</span> <span class="list-text">${displayMsg}</span></div>`;
                container.appendChild(div);
            });
        } catch (error) { container.innerHTML = '<div class="empty-msg">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!</div>'; }
    }

    class Snowflake {
        constructor(w, h) {
            this.x = Math.random() * w; this.y = Math.random() * h;
            this.size = Math.random() * 2 + 0.5; this.speed = Math.random() * 1 + 0.5;
            this.opacity = Math.random() * 0.5 + 0.3;
        }
        update(w, h) {
            this.y += this.speed; this.x += Math.sin(this.y * 0.05) * 0.5;
            if (this.y > h) { this.y = -10; this.x = Math.random() * w; }
        }
        draw(ctx) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
        }
    }

    class PartyFairy {
        constructor(msg, isPrivate, w, h) {
            this.msg = msg; 
            this.isPrivate = isPrivate; 
            this.x = Math.random() * (w - 60) + 30;
            this.y = Math.random() * (h - 100) + 80; 
            this.style = msg.style || { hair: 0, shirt: 0, acc: 0 };
            this.shirtColor = CUSTOM_SHIRT_COLORS[this.style.shirt] || CUSTOM_SHIRT_COLORS[0];
            this.bodyOffset = Math.random() * 100;
            this.dir = Math.random() < 0.5 ? -1 : 1;
            this.speed = 0.5 + Math.random();
            this.blinkTimer = Math.random() * 200;
            this.isBlinking = false;
            this.isHovered = false; 
        }
        update(w, h) {
            this.bodyOffset += 0.15;
            this.x += this.dir * this.speed * 0.3;
            if (this.x < 30 || this.x > w - 30) this.dir *= -1;
            this.blinkTimer--;
            if (this.blinkTimer <= 0) {
                this.isBlinking = true;
                if (this.blinkTimer <= -10) { this.isBlinking = false; this.blinkTimer = 100 + Math.random() * 200; }
            }
        }
        draw(ctx) {
            ctx.save(); ctx.translate(this.x, this.y);
            const bounce = Math.sin(this.bodyOffset) * 6; ctx.translate(0, bounce);
            if (this.isPrivate) { ctx.shadowColor = '#ff69b4'; ctx.shadowBlur = 20; }
            ctx.fillStyle = this.shirtColor; ctx.fillRect(-8, -15, 16, 20); 
            ctx.fillStyle = '#333'; ctx.fillRect(-8, 5, 16, 10); 
            ctx.fillStyle = '#fce4d4'; ctx.fillRect(-6, -24, 12, 9); 
            ctx.shadowBlur = 0; ctx.fillStyle = '#333';
            if (this.isBlinking) { ctx.fillRect(-4, -22, 3, 1); ctx.fillRect(2, -22, 3, 1); } else { ctx.fillRect(-4, -23, 2, 2); ctx.fillRect(2, -23, 2, 2); }
            this.drawHair(ctx);
            ctx.strokeStyle = this.shirtColor; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-8, -12); ctx.lineTo(-14, -12 - Math.cos(this.bodyOffset) * 5); ctx.moveTo(8, -12); ctx.lineTo(14, -12 + Math.cos(this.bodyOffset) * 5); ctx.stroke();
            this.drawAcc(ctx);
            this.drawBubble(ctx);
            ctx.restore();
        }
        drawHair(ctx) {
            ctx.fillStyle = '#4a3b2a'; const h = this.style.hair;
            if (h === 0) { ctx.fillRect(-7, -26, 14, 4); ctx.beginPath(); ctx.moveTo(-7, -24); ctx.lineTo(7, -24); ctx.quadraticCurveTo(8, -24, 8, -20); ctx.lineTo(-8, -20); ctx.quadraticCurveTo(-8, -24, -7, -24); ctx.fill(); } 
            else if (h === 1) { ctx.beginPath(); ctx.arc(0, -25, 8, Math.PI, 0); ctx.arc(-6, -23, 4, 0, Math.PI*2); ctx.arc(6, -23, 4, 0, Math.PI*2); ctx.arc(0, -28, 4, 0, Math.PI*2); ctx.fill(); } 
            else if (h === 2) { ctx.fillRect(-7, -26, 14, 4); ctx.beginPath(); ctx.arc(0, -28, 3.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(0, -28); ctx.quadraticCurveTo(5, -32, 6, -26); ctx.stroke(); } 
            else { ctx.fillRect(-8, -26, 16, 6); ctx.fillRect(-9, -22, 4, 12); ctx.fillRect(5, -22, 4, 12); }
        }
        drawAcc(ctx) {
            const a = this.style.acc;
            if (a === 1) { ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(-3, -25); ctx.lineTo(-8, -32); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-6, -29); ctx.lineTo(-4, -33); ctx.stroke(); ctx.beginPath(); ctx.moveTo(3, -25); ctx.lineTo(8, -32); ctx.stroke(); ctx.beginPath(); ctx.moveTo(6, -29); ctx.lineTo(4, -33); ctx.stroke(); ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0, -18, 1.5, 0, Math.PI*2); ctx.fill(); } 
            else if (a === 2) { ctx.fillStyle = '#ff69b4'; for(let i=0; i<5; i++) { const angle = (i * 2 * Math.PI) / 5; const r = 3; ctx.beginPath(); ctx.arc(6 + Math.cos(angle)*r, -28 + Math.sin(angle)*r, 2, 0, Math.PI*2); ctx.fill(); } ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(6, -28, 2, 0, Math.PI*2); ctx.fill(); }
        }
        drawBubble(ctx) {
            if (!this.assignedMessage) return;
            const msg = this.assignedMessage;
            ctx.save(); ctx.translate(this.x, this.y - 35);
            ctx.font = 'bold 14px "Pretendard", sans-serif'; const tm = ctx.measureText(msg.text), nm = ctx.measureText(msg.name);
            const w = Math.min(Math.max(tm.width, nm.width) + 24, 220); 
            const words = msg.text.split('');
            let lines = []; let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                const width = ctx.measureText(currentLine + words[i]).width;
                if (width < 200) { currentLine += words[i]; } 
                else { lines.push(currentLine); currentLine = words[i]; }
            }
            lines.push(currentLine);
            const h = lines.length * 18 + 30; 
            let bubbleX = 0;
            if (this.x - w/2 < 10) bubbleX = 10 - (this.x - w/2);
            if (this.x + w/2 > canvas.width - 10) bubbleX = (canvas.width - 10) - (this.x + w/2);
            ctx.translate(bubbleX, 0);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; ctx.shadowColor = 'rgba(0,0,0,0.2)'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.roundRect(-w/2, -h, w, h, 12); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-bubbleX, 0); ctx.lineTo(-bubbleX - 6, -6); ctx.lineTo(-bubbleX + 6, -6); ctx.fill();
            ctx.shadowBlur = 0; ctx.fillStyle = '#334155'; ctx.textAlign = 'center'; 
            lines.forEach((line, i) => { ctx.fillText(line, 0, -h + 20 + (i * 18)); });
            ctx.font = '500 12px "Pretendard"'; ctx.fillStyle = '#64748b'; 
            let displayName = msg.name;
            if (displayName === 'ALL') { ctx.fillStyle = '#00e676'; displayName = 'ëª¨ë‘ì—ê²Œ'; } else { ctx.fillStyle = '#ec4899'; }
            ctx.fillText(`To. ${displayName}`, 0, -10);
            ctx.restore();
        }
    }

    function animateMailbox() {
        if (myMsgModal.style.display === 'none' || currentViewMode !== 'scene') return; 
        mbCtx.clearRect(0, 0, mbCanvas.width, mbCanvas.height);
        const time = Date.now() * 0.0005;
        const g = mbCtx.createLinearGradient(0, 0, 0, mbCanvas.height);
        g.addColorStop(0, '#0f172a'); g.addColorStop(1, '#312e81'); 
        mbCtx.fillStyle = g; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);
        mbCtx.save(); mbCtx.globalCompositeOperation = 'screen';
        const lightX = mbCanvas.width/2 + Math.sin(time) * 100;
        const lg = mbCtx.createRadialGradient(lightX, mbCanvas.height, 10, lightX, mbCanvas.height, 200);
        lg.addColorStop(0, 'rgba(56, 189, 248, 0.3)'); lg.addColorStop(1, 'rgba(56, 189, 248, 0)');
        mbCtx.fillStyle = lg; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height); mbCtx.restore();
        mbSnowflakes.forEach(s => { s.update(mbCanvas.width, mbCanvas.height); s.draw(mbCtx); });
        let hoveredDancer = null;
        mbDancers.forEach(d => {
            d.update(mbCanvas.width, mbCanvas.height);
            const dx = mbMouse.x - d.x; const dy = mbMouse.y - d.y;
            if (Math.sqrt(dx*dx + dy*dy) < 30) hoveredDancer = d;
            d.isHovered = false; 
        });
        if (hoveredDancer) hoveredDancer.isHovered = true;
        mbDancers.sort((a, b) => a.y - b.y);
        mbDancers.forEach(d => { if (d !== hoveredDancer) d.draw(mbCtx); });
        if (hoveredDancer) hoveredDancer.draw(mbCtx);
        mbAnimationId = requestAnimationFrame(animateMailbox);
    }

    async function checkMyMessages() {
        const myName = myNameInput.value.trim();
        if (!myName) return alert("ë³¸ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        mbPlaceholder.style.display = 'block'; mbPlaceholder.innerHTML = 'âœ¨ ìš°í¸í•¨ íŒŒí‹°ì¥ ì…ì¥ ì¤‘... âœ¨';
        mbListContainer.innerHTML = '<div class="empty-msg">ë¡œë”© ì¤‘...</div>';
        mbDancers = []; mbSnowflakes = [];
        resizeMailboxCanvas();
        for(let i=0; i<50; i++) mbSnowflakes.push(new Snowflake(mbCanvas.width, mbCanvas.height));
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); 
            if (!data || data.length === 0) { 
                const emptyText = 'ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´ìš” ğŸ˜¢';
                mbPlaceholder.innerHTML = emptyText; mbListContainer.innerHTML = `<div class="empty-msg">${emptyText}</div>`; return; 
            }
            const myMessages = data.filter(row => row[1] === 'ALL' || row[1].replace(/\s/g, '') === myName.replace(/\s/g, ''));
            if (myMessages.length === 0) {
                const emptyText = `'${myName}'ë‹˜ê³¼ ëª¨ë‘ì—ê²Œ ë„ì°©í•œ<br>ë©”ì‹œì§€ê°€ ì•„ì§ ì—†ë„¤ìš”. í……~`;
                mbPlaceholder.innerHTML = emptyText; mbListContainer.innerHTML = `<div class="empty-msg">${emptyText}</div>`; return;
            }
            mbListContainer.innerHTML = '';
            myMessages.forEach(row => {
                const dateRaw = new Date(row[0]); const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
                const div = document.createElement('div'); div.className = 'list-item';
                let displayMsg = row[2] || "";
                let prefix = (row[1] === 'ALL') ? '<span style="color:#00e676; font-size:0.8rem; margin-right:5px; font-weight:bold;">[ì „ì²´]</span>' : '<span style="color:#ec4899; font-size:0.8rem; margin-right:5px; font-weight:bold;">[ë‚˜ì—ê²Œ]</span>';
                div.innerHTML = `<div class="list-date">${dateStr}</div><div>${prefix}<span class="list-text" style="font-weight:bold;">${displayMsg}</span></div>`;
                mbListContainer.appendChild(div);
            });
            mbPlaceholder.style.display = 'none'; 
            const displayMessages = myMessages.slice(0, 10); 
            displayMessages.forEach(row => {
                const isPrivate = (row[1] !== 'ALL');
                let text = row[2] || "";
                let styleJson = row[3];
                let style = { hair: 0, shirt: 0, acc: 0 };
                if (styleJson) { try { style = JSON.parse(styleJson); } catch(e) {} }
                mbDancers.push(new PartyFairy({ name: row[1], text: text, style: style }, isPrivate, mbCanvas.width, mbCanvas.height));
            });
            if (currentViewMode === 'scene') { if (mbAnimationId) cancelAnimationFrame(mbAnimationId); animateMailbox(); }
        } catch (error) { 
            mbPlaceholder.innerHTML = 'ì…ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'; mbListContainer.innerHTML = '<div class="empty-msg">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'none'; overlay.style.display = 'none';
            if (targetId === 'my-msg-modal') { if (mbAnimationId) cancelAnimationFrame(mbAnimationId); }
        });
    });
    function hideAllModals() {
        myMsgModal.style.display = 'none'; overlay.style.display = 'none';
        if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
    }
    overlay.addEventListener('click', hideAllModals);
    
    window.openMyMsgModal = () => {
        myMsgModal.style.display = 'flex'; overlay.style.display = 'block'; 
        setMailboxTab('MY');
        myNameInput.focus();
        mbPlaceholder.style.display = 'block'; mbPlaceholder.innerHTML = 'ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        mbListContainer.innerHTML = ''; mbCtx.clearRect(0,0, mbCanvas.width, mbCanvas.height);
        resizeMailboxCanvas(); mbSnowflakes = []; for(let i=0; i<30; i++) mbSnowflakes.push(new Snowflake(mbCanvas.width, mbCanvas.height));
        if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
        function waitLoop() {
            if (myMsgModal.style.display === 'none' || mbDancers.length > 0 || currentViewMode !== 'scene' || currentMailboxTab !== 'MY') return;
            mbCtx.fillStyle = '#0f172a'; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);
            mbSnowflakes.forEach(s => { s.update(mbCanvas.width, mbCanvas.height); s.draw(mbCtx); });
            mbAnimationId = requestAnimationFrame(waitLoop);
        }
        waitLoop();
    };
    window.addEventListener('resize', () => { if (myMsgModal.style.display === 'flex') { resizeMailboxCanvas(); } }); 

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Config
    const CONFIG = { 
        text: 'dotmill', font: '900 120px "Pretendard", Arial', pixelSize: 5, 
        builderCount: 15, engineerCount: 3, officeCount: 50, 
        colors: ['#0ea5e9', '#334155', '#475569', '#1e293b'], 
        dropInterval: 300, beltSpeed: 2 
    };

    let particles=[], fairies=[], beltOffset=0, lastDropTime=0, mouseX=0, mouseY=0, hoveredFairy=null;
    let monitorHueOffset = 0, isLogoComplete = false;
    let zones={ hopper:{x:0,y:0}, beltStart:{x:0,y:0}, beltEnd:{x:0,y:0}, storage:{x:0,y:0}, office:{x:0,y:0,w:0,h:0} };

    let vacationCounter = 0;
    let isSantaMode = false;
    let santaTimer = null;
    let speedLevel = 1; 
    const BASE_SPEED_FACTOR = 0.7; 
    let GAME_SPEED = speedLevel * BASE_SPEED_FACTOR; 
    let isGamePaused = false;
    let clickCount = 0;
    let clickTimer = null;
    let mainSnowflakes = [];
    let santaObj = { x: -200, y: 100, active: false };

    window.togglePause = () => {
        isGamePaused = !isGamePaused;
        const btn = document.getElementById('btn-pause');
        btn.innerText = isGamePaused ? 'â–¶' : 'â¸';
    };

    window.toggleSpeed = () => {
        if (speedLevel === 1) speedLevel = 2;
        else if (speedLevel === 2) speedLevel = 4;
        else if (speedLevel === 4) speedLevel = 8;
        else speedLevel = 1;
        GAME_SPEED = speedLevel * BASE_SPEED_FACTOR;
        document.getElementById('btn-speed').innerText = speedLevel + 'x';
    };

    let isHelpOpen = false;
    window.toggleHelp = () => {
        isHelpOpen = !isHelpOpen;
        const btn = document.getElementById('btn-help');
        const popup = document.getElementById('help-popup');
        if (isHelpOpen) { btn.classList.add('active'); popup.style.display = 'block'; } 
        else { btn.classList.remove('active'); popup.style.display = 'none'; }
    };

    window.handleGuideClick = () => {
        const guideText = document.getElementById('guide-text');
        guideText.classList.remove('shake');
        void guideText.offsetWidth; guideText.classList.add('shake');
        clickCount++;
        if (clickTimer) clearTimeout(clickTimer);
        clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        if (clickCount >= 10) { clickCount = 0; triggerDotPour(); }
    };

    function triggerDotPour() {
        const guideText = document.getElementById('guide-text');
        const rect = guideText.getBoundingClientRect();
        const startX = rect.left + rect.width / 2;
        const startY = rect.bottom; 
        for(let i=0; i<10; i++) {
            let targetP = null;
            if (particles.length > 0) { targetP = particles[Math.floor(Math.random() * particles.length)]; }
            const p = new Particle(0, 0, CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]);
            p.x = startX + (Math.random() - 0.5) * 50; p.y = startY; p.state = 'FALLING_FROM_TEXT';
            if (targetP) { p.targetX = targetP.targetX; p.targetY = targetP.targetY; } 
            else { p.targetX = canvas.width/2 + (Math.random()-0.5)*100; p.targetY = canvas.height/2 + (Math.random()-0.5)*50; }
            particles.push(p);
        }
    }
    
    window.resetSimulation = () => {
        particles.forEach(p => { 
            if (p.state === 'PLACED' || p.state === 'ON_BELT' || p.state === 'IN_STORAGE' || p.state === 'CARRIED' || p.state === 'DELIVERING' || p.state === 'FALLING' || p.state === 'FALLING_FROM_TEXT') {
                p.reset(); 
            }
        });
        fairies.forEach(f => { 
            if(!f.isPaused) { 
                if(f.targetItem) { f.targetItem.reset(); f.targetItem = null; } 
                if (f.busyState === 'SWEEPING' || f.busyState === 'MOVING_TO_SWEEP') { f.busyState = 'NONE'; }
                f.state = 'IDLE'; 
            } 
        });
        isLogoComplete = false; mainSnowflakes = []; santaObj.active = false;
        playSound('reset');
    };

    function triggerSantaMode() {
        isSantaMode = true;
        if(santaTimer) clearTimeout(santaTimer);
        santaTimer = setTimeout(() => { isSantaMode = false; }, 7000); 
    }

    class MainSnowflake {
        constructor(w, h) {
            this.x = Math.random() * w; this.y = Math.random() * h;
            this.size = Math.random() * 3 + 1; this.speed = Math.random() * 2 + 1;
            this.opacity = Math.random() * 0.7 + 0.3;
        }
        update(w, h, speed) {
            this.y += this.speed * speed; this.x += Math.sin(this.y * 0.02) * 0.5 * speed;
            if (this.y > h) { this.y = -10; this.x = Math.random() * w; }
        }
        draw(ctx) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
            ctx.fillRect(this.x, this.y, this.size, this.size); 
        }
    }

    function drawPixelSanta(ctx, x, y) {
        ctx.save(); ctx.translate(x, y); const scale = 3; ctx.scale(scale, scale);
        ctx.fillStyle = '#8B4513'; ctx.fillRect(0, 5, 8, 5); ctx.fillRect(0, 10, 2, 4); ctx.fillRect(6, 10, 2, 4); ctx.fillRect(6, 3, 3, 3); 
        ctx.fillStyle = '#D2691E'; ctx.fillRect(7, 1, 1, 2);
        ctx.fillStyle = 'red'; ctx.fillRect(9, 4, 1, 1);
        ctx.strokeStyle = '#555'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, 7); ctx.lineTo(-5, 7); ctx.stroke();
        ctx.fillStyle = '#A52A2A'; ctx.fillRect(-15, 8, 12, 4); ctx.fillRect(-15, 6, 2, 2);
        ctx.fillStyle = '#FFD700'; ctx.fillRect(-16, 12, 14, 1);
        ctx.fillStyle = 'red'; ctx.fillRect(-12, 4, 6, 6);
        ctx.fillStyle = '#fce4d4'; ctx.fillRect(-11, 2, 4, 3);
        ctx.fillStyle = 'white'; ctx.fillRect(-11, 4, 4, 2);
        ctx.fillStyle = 'red'; ctx.fillRect(-11, 0, 4, 2);
        ctx.restore();
    }
    
    function drawStarlightText(ctx, text, x, y) {
        const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = 600; tempCanvas.height = 100;
        tempCtx.font = '900 50px "Pretendard", sans-serif'; tempCtx.fillStyle = '#fff';
        tempCtx.textAlign = 'center'; tempCtx.textBaseline = 'middle';
        tempCtx.fillText(text, tempCanvas.width / 2, tempCanvas.height / 2);
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height); const data = imageData.data;
        ctx.save();
        const offsetX = x - tempCanvas.width / 2; const offsetY = y - tempCanvas.height / 2; const step = 4; 
        for (let py = 0; py < tempCanvas.height; py += step) {
            for (let px = 0; px < tempCanvas.width; px += step) {
                const index = (py * tempCanvas.width + px) * 4;
                if (data[index + 3] > 128) { 
                    const twinkle = Math.random() > 0.8 ? 1.5 : 1; const size = Math.random() * 2 * twinkle;
                    const colors = ['#ffffff', '#fffacd', '#ffd700', '#c0c0c0'];
                    ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                    ctx.beginPath(); ctx.arc(offsetX + px, offsetY + py, size, 0, Math.PI * 2); ctx.fill();
                }
            }
        }
        ctx.restore();
    }

    class Particle {
        constructor(tx,ty,c){
            this.targetX=tx; this.targetY=ty; this.baseColor=c;
            this.x=zones.hopper.x+(Math.random()-0.5)*40; this.y=zones.hopper.y-20;
            this.state='WAITING'; this.carrier=null;
            const rand = Math.random();
            if (rand < 0.85) { this.treeColor = '#22c55e'; } else if (rand < 0.90) { this.treeColor = '#eab308'; } else if (rand < 0.95) { this.treeColor = '#ef4444'; } else { this.treeColor = '#854d0e'; }
        }
        update(){
            if (isGamePaused) return;
            if (this.state === 'FALLING_FROM_TEXT') {
                this.y += 5 * GAME_SPEED; 
                if (this.y >= zones.storage.y) { this.state = 'IN_STORAGE'; this.y = zones.storage.y + (Math.random()-0.5)*20; }
                return;
            }
            if(this.state==='WAITING')return;
            if(this.state==='FALLING'){
                this.y+=4 * GAME_SPEED; 
                if(this.y>=zones.beltStart.y-10){this.y=zones.beltStart.y-10+Math.random()*5;this.state='ON_BELT';}
            } else if(this.state==='ON_BELT'){
                const dx=zones.beltEnd.x-zones.beltStart.x,dy=zones.beltEnd.y-zones.beltStart.y,d=Math.sqrt(dx*dx+dy*dy);
                this.x+=(dx/d)*CONFIG.beltSpeed * GAME_SPEED; this.y+=(dy/d)*CONFIG.beltSpeed * GAME_SPEED; 
                if(this.x>=zones.beltEnd.x){this.state='IN_STORAGE';this.x=zones.storage.x+(Math.random()-0.5)*30;this.y=zones.storage.y+(Math.random()-0.5)*20;}
            } else if(this.state==='RETURNING'){
                const dx=zones.hopper.x-this.x,dy=zones.hopper.y-this.y;
                this.x+=dx*0.1 * GAME_SPEED; this.y+=dy*0.1 * GAME_SPEED; 
                if(Math.abs(dy)<5)this.state='WAITING';
            }
        }
        draw(){
            if(this.state==='WAITING')return;
            // [CHANGED] ë¡œê³  ì™„ì„± ì‹œ íŠ¸ë¦¬ íŒ¨í„´ ìƒ‰ìƒ ì‚¬ìš©
            if (typeof isLogoComplete !== 'undefined' && isLogoComplete && this.state === 'PLACED') { ctx.fillStyle = this.treeColor; } else { ctx.fillStyle = this.baseColor; }
            if(this.state==='PLACED') {
                // [CHANGED] ë¡œê³  ì™„ì„± ì‹œ Glow íš¨ê³¼
                if(isLogoComplete) {
                     ctx.shadowColor = this.treeColor; ctx.shadowBlur = 10;
                } else { ctx.shadowBlur = 0; }
                ctx.fillRect(this.x,this.y,CONFIG.pixelSize,CONFIG.pixelSize);
                ctx.shadowBlur = 0; // reset
            } else {
                ctx.beginPath(); ctx.arc(this.x,this.y,CONFIG.pixelSize/2+1,0,Math.PI*2); ctx.fill();
            }
        }
        reset(){this.state='RETURNING';this.carrier=null;}
    }

    class Fairy {
        constructor(role, idx) {
            this.role = role; this.x = canvas.width/2; this.y = canvas.height/2; this.targetItem = null; this.state = 'IDLE';
            this.colorShirt = ['#a3d2ca', '#ffc3a0', '#fff'][Math.floor(Math.random()*3)]; this.animFrame = Math.random()*100;
            this.isPaused=false; this.pauseTimer=null; this.busyState='NONE'; this.busyTimer=Math.random()*500;
            this.busyTargetX=0; this.busyTargetY=0; this.seatX=0; this.seatY=0;
            this.assignedMessage = null; this.assignmentTime = 0; 
            this.customStyle = null; 
            if(role==='ENGINEER'){this.x=zones.beltStart.x+(zones.beltEnd.x-zones.beltStart.x)*0.5;this.y=zones.beltStart.y+30;}
            else if(role==='OFFICE'){ const c=Math.ceil(CONFIG.officeCount/2),r=Math.floor(idx/c),cl=idx%c,dw=60,dh=60,tw=c*dw,sx=(canvas.width-tw)/2+30,sy=zones.office.y+50; this.seatX=sx+cl*dw;this.seatY=sy+r*dh;this.x=this.seatX;this.y=this.seatY;this.busyState='TYPING';} 
            else if(role==='FOREMAN'){ this.x = canvas.width/2 - 250; this.y = canvas.height/2 - 20; }
        }
        giveVacation() { 
            this.isPaused=true; playSound('rest'); 
            if(this.pauseTimer)clearTimeout(this.pauseTimer); 
            this.pauseTimer=setTimeout(()=>{this.isPaused=false;},5000); 
            vacationCounter++; if(vacationCounter >= 5) { triggerSantaMode(); vacationCounter = 0; }
        }
        update() { 
            if(this.isPaused) return; 
            if (!isGamePaused) {
                this.animFrame += 0.1 * GAME_SPEED; 
                if (isLogoComplete && this.role === 'BUILDER') { this.updateSweeper(); } 
                else { if(this.role==='BUILDER') this.updateBuilder(); else if(this.role==='OFFICE') this.updateOffice(); }
            }
        }
        updateSweeper() {
             if (this.busyState !== 'SWEEPING' && this.busyState !== 'MOVING_TO_SWEEP') {
                 this.busyState = 'MOVING_TO_SWEEP';
                 this.busyTargetX = canvas.width * 0.1 + Math.random() * canvas.width * 0.8;
                 this.busyTargetY = canvas.height * 0.5 + Math.random() * canvas.height * 0.4;
             }
             if (this.busyState === 'MOVING_TO_SWEEP') {
                 if(this.moveTo(this.busyTargetX, this.busyTargetY)) { this.busyState = 'SWEEPING'; this.busyTimer = 100 + Math.random() * 100; }
             } else if (this.busyState === 'SWEEPING') {
                 this.busyTimer -= 1 * GAME_SPEED;
                 if (this.busyTimer <= 0) {
                     this.busyState = 'MOVING_TO_SWEEP';
                     this.busyTargetX = canvas.width * 0.1 + Math.random() * canvas.width * 0.8;
                     this.busyTargetY = canvas.height * 0.5 + Math.random() * canvas.height * 0.4;
                 }
             }
        }
        updateOffice(){
            if(this.busyState==='TYPING'){
                this.busyTimer -= 1 * GAME_SPEED; 
                if(this.busyTimer<=0){ if(Math.random()<0.05){this.busyState='PATROL';this.busyTargetX=zones.office.x+Math.random()*zones.office.w;this.busyTargetY=zones.office.y+Math.random()*zones.office.h;} else{this.busyTimer=200+Math.random()*400;} }
            } else if(this.busyState==='PATROL'){
                if(this.moveTo(this.busyTargetX,this.busyTargetY)){ this.busyState='WAITING_TO_RETURN';this.busyTimer=50+Math.random()*100; }
            } else if(this.busyState==='WAITING_TO_RETURN'){
                this.busyTimer -= 1 * GAME_SPEED; if(this.busyTimer<=0)this.busyState='RETURN';
            } else if(this.busyState==='RETURN'){
                if(this.moveTo(this.seatX,this.seatY)){ this.busyState='TYPING';this.busyTimer=300+Math.random()*500; }
            }
        }
        updateBuilder(){
            if(!this.targetItem){
                const job=particles.find(p=>p.state==='IN_STORAGE'&&!p.carrier);
                if(job){ this.busyState='NONE';this.targetItem=job;job.carrier=this;this.state='MOVING_TO_STORAGE'; } else { this.performBusyAction(); }
            } else {
                if(this.targetItem.state==='RETURNING'){this.targetItem=null;this.state='IDLE';return;}
                if(this.state==='MOVING_TO_STORAGE'){if(this.moveTo(this.targetItem.x,this.targetItem.y)){this.targetItem.state='CARRIED';this.state='DELIVERING';}}
                else if(this.state==='DELIVERING'){this.targetItem.x=this.x;this.targetItem.y=this.y-12;if(this.moveTo(this.targetItem.targetX,this.targetItem.targetY)){this.targetItem.state='PLACED';this.targetItem.x=this.targetItem.targetX;this.targetItem.y=this.targetItem.targetY;this.targetItem.carrier=null;this.targetItem=null;this.state='IDLE';}}
            }
        }
        performBusyAction(){
            if(this.busyTimer<=0){
                const r=Math.random();
                if(r<0.5){this.busyState='PATROL';this.busyTargetX=canvas.width/2+(Math.random()-0.5)*400;this.busyTargetY=canvas.height/2+(Math.random()-0.5)*150;}
                else if(r<0.8)this.busyState='CLEAN'; else this.busyState='HAMMER';
                this.busyTimer=60+Math.random()*120;
            }
            this.busyTimer -= 1 * GAME_SPEED; 
            if(this.busyState==='PATROL')this.moveTo(this.busyTargetX,this.busyTargetY);
            else if(this.busyState==='CLEAN')this.x+=Math.sin(Date.now()*0.02 * GAME_SPEED)*0.5 * GAME_SPEED;
            else if(this.busyState==='HAMMER'){if(Math.abs(this.x-canvas.width/2)>300)this.moveTo(canvas.width/2,canvas.height/2);}
        }
        moveTo(tx,ty){
            const dx=tx-this.x,dy=ty-this.y,d=Math.sqrt(dx*dx+dy*dy);
            const baseSpeed = this.role==='OFFICE'?1.5:4;
            const moveStep = baseSpeed * GAME_SPEED; 
            if(d < moveStep || d < 4){this.x=tx;this.y=ty;return true;}
            this.x+=(dx/d)*moveStep; this.y+=(dy/d)*moveStep; return false;
        }
        drawBroom(ctx) {
            ctx.save();
            const angle = Math.sin(Date.now() * 0.01 * GAME_SPEED) * 0.5;
            ctx.rotate(angle);
            ctx.fillStyle = '#8d6e63'; ctx.fillRect(4, -5, 2, 20);
            ctx.fillStyle = '#fbc02d'; ctx.beginPath(); ctx.moveTo(3, 15); ctx.lineTo(7, 15); ctx.lineTo(9, 22); ctx.lineTo(1, 22); ctx.fill();
            ctx.restore();
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            let shirtColor = this.colorShirt;
            if (this.customStyle) { shirtColor = CUSTOM_SHIRT_COLORS[this.customStyle.shirt] || CUSTOM_SHIRT_COLORS[0]; }
            let indicatorColor = null;
            if (this.isPaused) { ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 20; } 
            else if (this.assignedMessage) {
                const timeDiff = Date.now() - this.assignmentTime;
                if (timeDiff < 2000) { ctx.shadowColor = '#00e676'; ctx.shadowBlur = 25; indicatorColor = '#00e676'; } 
                else { indicatorColor = '#2979ff'; ctx.shadowBlur = 0; }
            } else { ctx.shadowBlur = 0; }
            
            const sway = isGamePaused ? 0 : Math.sin(Date.now()*0.05 * GAME_SPEED);
            if(!this.isPaused && (this.busyState==='HAMMER'||(this.role==='OFFICE'&&this.busyState==='TYPING') || this.busyState==='SWEEPING')) ctx.translate(0, sway);
            if (indicatorColor) { ctx.fillStyle = indicatorColor; ctx.beginPath(); ctx.arc(0, -18, 3.5, 0, Math.PI*2); ctx.fill(); }
            const w=12,h=20; 
            ctx.fillStyle='#333';ctx.fillRect(-w/2,0,w,h/2); // Pants
            ctx.fillStyle=shirtColor;ctx.fillRect(-w/2,-h/2,w,h/2); // Shirt
            ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2+2,-h/2-6,8,8); // Face

            if (this.customStyle) {
                ctx.save(); ctx.translate(0, 8); 
                ctx.fillStyle = '#4a3b2a'; const hr = this.customStyle.hair;
                if (hr === 0) { ctx.fillRect(-7, -26, 14, 4); ctx.beginPath(); ctx.moveTo(-7, -24); ctx.lineTo(7, -24); ctx.quadraticCurveTo(8, -24, 8, -20); ctx.lineTo(-8, -20); ctx.quadraticCurveTo(-8, -24, -7, -24); ctx.fill(); } 
                else if (hr === 1) { ctx.beginPath(); ctx.arc(0, -25, 8, Math.PI, 0); ctx.arc(-6, -23, 4, 0, Math.PI*2); ctx.arc(6, -23, 4, 0, Math.PI*2); ctx.arc(0, -28, 4, 0, Math.PI*2); ctx.fill(); } 
                else if (hr === 2) { ctx.fillRect(-7, -26, 14, 4); ctx.beginPath(); ctx.arc(0, -28, 3.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(0, -28); ctx.quadraticCurveTo(5, -32, 6, -26); ctx.stroke(); } 
                else { ctx.fillRect(-8, -26, 16, 6); ctx.fillRect(-9, -22, 4, 12); ctx.fillRect(5, -22, 4, 12); }

                const ac = this.customStyle.acc;
                if (ac === 1) { ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(-3, -25); ctx.lineTo(-8, -32); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-6, -29); ctx.lineTo(-4, -33); ctx.stroke(); ctx.beginPath(); ctx.moveTo(3, -25); ctx.lineTo(8, -32); ctx.stroke(); ctx.beginPath(); ctx.moveTo(6, -29); ctx.lineTo(4, -33); ctx.stroke(); ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0, -18, 1.5, 0, Math.PI*2); ctx.fill(); } 
                else if (ac === 2) { ctx.fillStyle = '#ff69b4'; for(let i=0; i<5; i++) { const angle = (i * 2 * Math.PI) / 5; const r = 3; ctx.beginPath(); ctx.arc(6 + Math.cos(angle)*r, -28 + Math.sin(angle)*r, 2, 0, Math.PI*2); ctx.fill(); } ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(6, -28, 2, 0, Math.PI*2); ctx.fill(); }
                ctx.restore();
            }
            if (isSantaMode) {
                ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(-6, -16); ctx.lineTo(0, -26); ctx.lineTo(6, -16); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.fillRect(-7, -16, 14, 3); ctx.beginPath(); ctx.arc(0, -26, 2, 0, Math.PI*2); ctx.fill();
            }
            if(this.role==='FOREMAN'){ctx.fillStyle='#ffcc00';ctx.fillRect(-w/2,-h/2-8,w,4);ctx.strokeStyle='red';ctx.beginPath();ctx.moveTo(w/2,-h/2);ctx.lineTo(w/2+10,-h/2-5);ctx.stroke();}
            else if(this.role==='ENGINEER'){ctx.save();ctx.translate(w/2,0);ctx.rotate(Math.sin(this.animFrame)*0.5);ctx.fillStyle='#888';ctx.fillRect(0,-2,10,4);ctx.restore();}
            else if(this.role==='OFFICE'){ctx.fillStyle='#333';ctx.fillRect(-w/2+3,-h/2-3,6,2);}
            else if(this.role==='BUILDER'&&this.state==='DELIVERING'){ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2-2,-h/2,2,6);ctx.fillRect(w/2,-h/2,2,6);}
            
            if (this.busyState === 'SWEEPING' || this.busyState === 'MOVING_TO_SWEEP') {
                this.drawBroom(ctx);
            } else if (this.role === 'BUILDER' && !this.isPaused) {
                if (this.busyState === 'CLEAN') {
                    ctx.save(); ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(4, 5); ctx.lineTo(4 + Math.sin(Date.now()*0.02 * GAME_SPEED)*8, 18); ctx.stroke();
                    ctx.fillStyle='#d7ccc8'; ctx.beginPath(); ctx.arc(4 + Math.sin(Date.now()*0.02 * GAME_SPEED)*8, 18, 3, 0, Math.PI); ctx.fill(); ctx.restore();
                } else if (this.busyState === 'HAMMER') {
                    ctx.save(); ctx.translate(6, 0); ctx.rotate(Math.sin(Date.now() * 0.2 * GAME_SPEED) * 0.8);
                    ctx.fillStyle = '#5d4037'; ctx.fillRect(0, -10, 2, 12); ctx.fillStyle = '#555'; ctx.fillRect(-3, -12, 8, 4); ctx.restore();
                }
            }
            ctx.restore();
        }
        drawBubble() {
            if (!this.assignedMessage) return;
            const msg = this.assignedMessage;
            ctx.save(); ctx.translate(this.x, this.y - 35);
            ctx.font = 'bold 14px "Pretendard", sans-serif'; const tm = ctx.measureText(msg.text), nm = ctx.measureText(msg.name);
            const w = Math.min(Math.max(tm.width, nm.width) + 24, 220); 
            const words = msg.text.split('');
            let lines = []; let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                const width = ctx.measureText(currentLine + words[i]).width;
                if (width < 200) { currentLine += words[i]; } 
                else { lines.push(currentLine); currentLine = words[i]; }
            }
            lines.push(currentLine);
            const h = lines.length * 18 + 30; 
            let bubbleX = 0;
            if (this.x - w/2 < 10) bubbleX = 10 - (this.x - w/2);
            if (this.x + w/2 > canvas.width - 10) bubbleX = (canvas.width - 10) - (this.x + w/2);
            ctx.translate(bubbleX, 0);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; ctx.shadowColor = 'rgba(0,0,0,0.2)'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.roundRect(-w/2, -h, w, h, 12); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-bubbleX, 0); ctx.lineTo(-bubbleX - 6, -6); ctx.lineTo(-bubbleX + 6, -6); ctx.fill();
            ctx.shadowBlur = 0; ctx.fillStyle = '#334155'; ctx.textAlign = 'center'; 
            lines.forEach((line, i) => { ctx.fillText(line, 0, -h + 20 + (i * 18)); });
            ctx.font = '500 12px "Pretendard"'; ctx.fillStyle = '#64748b'; 
            let displayName = msg.name;
            if (displayName === 'ALL') { ctx.fillStyle = '#00e676'; displayName = 'ëª¨ë‘ì—ê²Œ'; } else { ctx.fillStyle = '#ec4899'; }
            ctx.fillText(`To. ${displayName}`, 0, -10);
            ctx.restore();
        }
    }

    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        if (canvas.width === 0 || canvas.height === 0) return;
        zones.hopper = { x: 100, y: 100 }; zones.beltStart = { x: 100, y: 180 }; zones.beltEnd = { x: canvas.width * 0.3, y: canvas.height * 0.6 }; zones.storage = { x: canvas.width * 0.3 + 20, y: canvas.height * 0.6 + 20 }; zones.office = { x: 0, y: canvas.height - 200, w: canvas.width, h: 200 };
        particles=[]; fairies=[];
        ctx.font = CONFIG.font; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'white'; ctx.fillText(CONFIG.text, canvas.width / 2, canvas.height / 2);
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height); ctx.clearRect(0,0, canvas.width, canvas.height);
        for(let y=0; y<data.height; y+=CONFIG.pixelSize) for(let x=0; x<data.width; x+=CONFIG.pixelSize) if(data.data[(y * 4 * data.width) + (x * 4) + 3] > 128) particles.push(new Particle(x, y, CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]));
        fairies.push(new Fairy('FOREMAN'));
        for(let i=0; i<CONFIG.builderCount; i++) fairies.push(new Fairy('BUILDER'));
        for(let i=0; i<CONFIG.engineerCount; i++) fairies.push(new Fairy('ENGINEER'));
        for(let i=0; i<CONFIG.officeCount; i++) fairies.push(new Fairy('OFFICE', i));
    }

    function isVisible(f) { return f.x > 20 && f.x < canvas.width - 20 && f.y > 0 && f.y < canvas.height; }

    window.distributeSingleMessage = (newMsg) => {
        let target = fairies.find(f => f.assignedMessage === null && isVisible(f));
        if (!target) {
            const visibleFairies = fairies.filter(f => isVisible(f));
            if (visibleFairies.length > 0) { target = visibleFairies[Math.floor(Math.random() * visibleFairies.length)]; }Â 
            else { target = fairies[Math.floor(Math.random() * fairies.length)]; }
        }
        if (target) {Â 
            target.assignedMessage = newMsg;Â 
            target.assignmentTime = Date.now();
            if(newMsg.style) target.customStyle = newMsg.style;
        }
    };

    function drawEnvironment() {
        if (isLogoComplete) {
            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#0f172a'); grad.addColorStop(1, '#1e1b4b');
            ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        ctx.fillStyle = '#999'; ctx.beginPath(); ctx.moveTo(zones.hopper.x - 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 10, zones.hopper.y); ctx.lineTo(zones.hopper.x - 10, zones.hopper.y); ctx.fill();
        ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 40; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke();
        if (!isGamePaused) { beltOffset -= CONFIG.beltSpeed * GAME_SPEED; }
        ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 30; ctx.setLineDash([10, 20]); ctx.lineDashOffset = beltOffset; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke(); ctx.setLineDash([]);
        ctx.lineWidth = 5; ctx.strokeStyle = '#64748b'; ctx.beginPath(); ctx.moveTo(zones.beltEnd.x, zones.beltEnd.y); ctx.lineTo(zones.beltEnd.x, canvas.height); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltStart.x, canvas.height); ctx.stroke();
        const lx = canvas.width/2 - 250; const ly = canvas.height/2 + 60; ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(lx, ly - 120); ctx.moveTo(lx + 30, ly); ctx.lineTo(lx + 30, ly - 120); for(let i=0; i<5; i++) { ctx.moveTo(lx, ly - 20 - (i*20)); ctx.lineTo(lx+30, ly - 20 - (i*20)); } ctx.stroke();
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(zones.office.x, zones.office.y, zones.office.w, zones.office.h); ctx.fillStyle = '#e2e8f0'; ctx.fillRect(zones.office.x, canvas.height - 50, zones.office.w, 50);
        fairies.forEach((f, i) => {
            if (f.role === 'OFFICE') {
                const deskX = f.seatX; const deskY = f.seatY;
                ctx.fillStyle = '#cbd5e1'; ctx.fillRect(deskX - 25, deskY + 10, 50, 30); ctx.fillStyle = '#475569'; ctx.fillRect(deskX - 15, deskY - 20, 30, 25);Â 
                if (isLogoComplete) {
                     const phase = Date.now() * 0.003;
                     const b = Math.floor(150 + 105 * (Math.sin(phase) + 1) / 2);
                     ctx.fillStyle = `rgb(255, 255, ${b})`; ctx.shadowColor = `rgb(255, 255, ${b})`; ctx.shadowBlur = 10; 
                } else {
                    const hue = (monitorHueOffset + i * 10) % 360;
                    ctx.fillStyle = `hsl(${hue}, 70%, 80%)`; ctx.shadowBlur = 0;
                }
                ctx.fillRect(deskX - 13, deskY - 18, 26, 20); ctx.shadowBlur = 0;
            }
        });
        ctx.fillStyle = isLogoComplete ? 'rgba(255,255,255,0.5)' : '#94a3b8'; 
        ctx.font = 'bold 15px "Pretendard", sans-serif'; ctx.textAlign='right'; ctx.fillText('Â©shimhayeon', canvas.width - 50, canvas.height - 30);
    }
    
    function animate() {
        if (!isGamePaused) {
            const now = Date.now();Â 
            if (now - lastDropTime > CONFIG.dropInterval / GAME_SPEED) {Â 
                const p = particles.find(p => p.state === 'WAITING');Â 
                if (p) { p.state = 'FALLING'; lastDropTime = now; }Â 
            }
        }
        const placedCount = particles.filter(p => p.state === 'PLACED').length;
        if (!isLogoComplete && placedCount > 0 && placedCount === particles.length) {
            isLogoComplete = true;
            mainSnowflakes = [];
            for(let i=0; i<100; i++) mainSnowflakes.push(new MainSnowflake(canvas.width, canvas.height));
            santaObj.active = true; santaObj.x = -100; santaObj.y = 100;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);Â 
        drawEnvironment();Â 
        if (isLogoComplete) {
            if (!isGamePaused) { mainSnowflakes.forEach(s => s.update(canvas.width, canvas.height, GAME_SPEED)); }
            mainSnowflakes.forEach(s => s.draw(ctx));
            if (santaObj.active) {
                if (!isGamePaused) santaObj.x += 2 * GAME_SPEED;
                drawPixelSanta(ctx, santaObj.x, santaObj.y);
                if (santaObj.x > canvas.width + 100) santaObj.x = -100; 
            }
            drawStarlightText(ctx, "Happy New Year!", canvas.width/2, 150);
        }
        fairies.forEach(f => { f.update(); f.draw(); });Â 
        if (isLogoComplete) {
            ctx.save();
            const phase = Date.now() * 0.003;
            const b = Math.floor(150 + 105 * (Math.sin(phase) + 1) / 2);
            ctx.shadowColor = `rgb(255, 255, ${b})`;
            ctx.shadowBlur = 20 + 10 * Math.sin(phase * 1.5);
            particles.forEach(p => { p.update(); p.draw(); });
            ctx.restore();
        } else {
             particles.forEach(p => { p.update(); p.draw(); });
        }
        if (hoveredFairy) { hoveredFairy.drawBubble(); canvas.style.cursor = 'pointer'; } else { canvas.style.cursor = 'default'; }
        if (!isGamePaused) { monitorHueOffset += (isLogoComplete ? 5 : 1) * GAME_SPEED;Â }
        if (!isLogoComplete) { 
            ctx.save(); ctx.globalAlpha = 0.05; ctx.fillStyle = '#000'; 
            ctx.font = CONFIG.font; ctx.textAlign='center'; ctx.fillText(CONFIG.text, canvas.width/2, canvas.height/2); 
            ctx.restore();
        }
        requestAnimationFrame(animate);
    }
    
    // Initial Load function definition
    async function loadInitialMessages() {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json(); 
            if (data && data.length > 0) {
                const recent10 = [...data].reverse().slice(0, 10);
                const shuffledFairies = [...fairies].sort(() => 0.5 - Math.random());
                recent10.forEach((row, idx) => {
                    if (idx < shuffledFairies.length) {
                        const f = shuffledFairies[idx];
                        f.assignedMessage = { name: row[1], text: row[2] };
                        f.assignmentTime = Date.now(); 
                        let styleJson = row[3];
                        if (styleJson) { try { f.customStyle = JSON.parse(styleJson); } catch(e) {} }
                    }
                });
            }
        } catch (e) { console.error("Initial fetch failed:", e); }
    }

    canvas.addEventListener('touchstart', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('#audio-btn') || e.target.closest('.modal-window')) return;
        const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); const tx = touch.clientX - rect.left; const ty = touch.clientY - rect.top;
        let touchedFairy = false;
        fairies.forEach(f => {
            if (Math.abs(tx - f.x) < 40 && Math.abs(ty - f.y) < 50) {
                touchedFairy = true;
                if (f.assignedMessage) { hoveredFairy = f; playSound('pop'); setTimeout(() => { hoveredFairy = null; }, 3000); } 
                else { f.giveVacation(); }
            }
        });
    }, { passive: false });

    window.addEventListener('mousedown', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('.modal-window') || e.target.closest('#view-all-btn') || e.target.closest('#audio-btn')) return;
        const rect = canvas.getBoundingClientRect(); const cx = e.clientX - rect.left; const cy = e.clientY - rect.top;
        let clickedFairy = false; fairies.forEach(f => { if (Math.sqrt(Math.pow(cx-f.x,2)+Math.pow(cy-f.y,2)) < 30) { f.giveVacation(); clickedFairy = true; } }); 
    });

    let prevHoveredFairy = null; 
    window.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect(); mouseX = e.clientX - rect.left; mouseY = e.clientY - rect.top;
        let closest = null; let minDist = 30; 
        fairies.forEach(f => { const dx = mouseX - f.x; const dy = mouseY - f.y; const dist = Math.sqrt(dx*dx + dy*dy); if (dist < minDist) { minDist = dist; closest = f; } }); 
        hoveredFairy = closest;
        if (hoveredFairy) { canvas.style.cursor = 'pointer'; } else { canvas.style.cursor = 'default'; }
        if (closest !== prevHoveredFairy) { if (closest && closest.assignedMessage) { playSound('pop'); } prevHoveredFairy = closest; }
    });
    
    window.addEventListener('resize', init); 
    init(); 
    loadInitialMessages(); 
    animate();
</script>
</body>
</html>
